define(["crossroads","hasher","when"],function(e,t,n){return function(r){var i,s,o,u,a,f,l;return u=function(e,t){return l.parse(e)},s=null,l=void 0,i=function(t,r){return n.promise(function(t){return l=e.create(),t(l)})},f=function(e,n,i){var o,a,f,l,c,h,p;h=n.options.routes,p=[];for(o in h)f=h[o],c=f.spec,l=f.slot,r=f.options,a=function(e,t,n){return i.loadModule(e).then(function(e){return s!=null&&s.destroy(),e.slot=t,e.options=n,i.createChild(e).then(function(e){return s=e},function(e){return console.error(e.stack)})})}.bind(null,c,l,r),e.addRoute(o,a),t.initialized.add(u),p.push(t.changed.add(u));return p},o=function(e,t,n){return i(t,n).then(function(r){return f(r,t,n),e.resolve(r)},function(e){return console.error(e.stack)})},a={ready:function(e,t,n){return e.resolve()},destroy:function(e,t,n){return l.dispose(),e.resolve()},factories:{contextRouter:o}},a}});
