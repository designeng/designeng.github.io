var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define(["underscore","core/util/surrogate/Collection"],function(e,t){var n;return n=function(){function n(){this.guessContextResetRoutePositions=__bind(this.guessContextResetRoutePositions,this)}return n.prototype.currentParams=[],n.prototype.routeObserver=null,n.prototype._contextHash=new t,n.prototype.updateCachedItem=function(t,n){var r;return r=this._contextHash.find({route:t}),r==null?this._contextHash.addItem(e.extend({route:t},n)):this._contextHash.update({route:t},n)},n.prototype.register=function(e,t,n){var r,i,s;return r=this.routeStrategy.getBaseRoute(n.route),i=(s=n.params)!=null?s.input:void 0,this.updateCachedItem(r,{parentContext:e,hash:i}),this.updateCachedItem(n.route,{childContext:t,hash:i})},n.prototype.unregister=function(t){var n;return n=["child","parent"],e.each(n,function(e){return function(n){var r;return r=e.getRegistredContext(t,n),r!=null?r.destroy():void 0}}(this)),this._contextHash.reset()},n.prototype.onHashChanged=function(e){return this.destroyOnBlur(e.oldHash)},n.prototype.destroyOnBlur=function(t){var n,r,i,s;r=this._contextHash.where({hash:t}),i=n=e.filter(r,function(e){return e["childContext"]!=null})[0];if(i!=null&&((s=i["childContext"])!=null?s.__environmentVars.destroyOnBlur:void 0))return i.childContext.destroy(),this._contextHash.remove(i._id)},n.prototype.clearCache=function(){return this._contextHash.each(function(e){var t,n;return(t=e["childContext"])!=null&&t.destroy(),(n=e["parentContext"])!=null?n.destroy():void 0}),this._contextHash.reset()},n.prototype.getRegistredContext=function(e,t){var n,r,i;if(t==="parent")return n=this.routeStrategy.getBaseRoute(e),(r=this._contextHash.find({route:n}))!=null?r.parentContext:void 0;if(t==="child")return(i=this._contextHash.find({route:e}))!=null?i.childContext:void 0},n.prototype.ensureContext=function(e){return e.destroy&&e.resolve&&e.wire?!0:!1},n.prototype.startContextHashRevision=function(e){var t,n;n=this.calculatePositions(e);if(!this.theSame(e.params,this.currentParams)){t=this.indexesOfMutation(e.params,this.currentParams);if(this.changesOccurred(t,n))return this.unregister(e.route),this.currentParams=e.params}},n.prototype.guessContextResetRoutePositions=function(t){var n,r;return n=this.normalizeRoute(t),r=e.reduce(n,function(e,t,n){return t.match("\\{(.*)}")&&e.push(n),e},[]),r},n.prototype.normalizeRoute=function(t){if(e.isArray(t))return t;if(e.isString(t))return t.split("/")},n.prototype.validate=function(t,n){return e.reduce(t,function(t,r){return e.indexOf(n,r)===-1&&(t*=0),t},1)},n.prototype.calculatePositions=function(e){var t,n,r;r=this.guessContextResetRoutePositions(e.route),t=e.contextResetRoutePositions;if(t){n=this.validate(t,r);if(!n)throw new Error("Provided for child route '"+e.route+"' contextResetRoutePositions is not valid!");return t}return r},n.prototype.theSame=function(t,n){return e.all(e.zip(t,n),function(e){return e[0]===e[1]})},n.prototype.indexesOfMutation=function(t,n){return e.reduce(e.zip(t,n),function(e,t,n){return t[0]!==t[1]&&e.push(n),e},[])},n.prototype.changesOccurred=function(t,n){return!!e.intersection(t,n).length},n}()});
