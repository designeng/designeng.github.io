var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["underscore","jquery","when","meld","wire/lib/object","core/util/surrogate/ClonedCollection","kefir","kefirJquery"],function(e,t,n,r,i,s,o,u){return u.init(o,t),function(n){var o,u,a,f,l,c,h,p,d,v,m,g,y;return y=null,g=[],p=function(e){return e&&i.hasOwn(e,"$ref")},o=function(t,n){var i,s;if(!p(t))throw new Error("Filter should be described as wire reference!");return i=["after"],s=e.filter(e.keys(t),function(e){return e!=="$ref"&&__indexOf.call(i,e)>=0}),e.each(s,function(e){var i,s,o,u;return u=h(t[e]),s=u[0],i=u[1],o={provider:{$ref:s},filter:t},n(o).then(function(t){return g.push(r[e](t.provider,i,function(e){return y._filterOptions=e,y.applyFilter(t.filter)}))})})},h=function(e){return e.split(".").slice(0,2)},f=function(t,n){if(!e.isFunction(t[n]))throw new Error("Method "+n+" should be defined in the object class!");return!0},d=function(t){if(e.isArray(t))return t;if(p(t))return[t];if(e.isFunction(t))return[t]},c=function(e,t,n){return n(t.options).then(function(t){return y=new s,g.push(r.after(t,"addSource",function(e){return y.cloneSource(e)})),y.cloneSource(t.getSource()),e.resolve(y)})},u=function(t,n,r){var i;return i=d(n.options),e.each(i,function(e){return o(e,r)}),t.resolve()},v=function(t,n,i){return i(n.options).then(function(n){if(!e.isFunction(n))throw new Error("Provided to onFiltered facet should be function!");return g.push(r.after(y,"applyFilter",function(e){return n(e)})),t.resolve()})},a=function(n,r,i){var s,o,u;return s=[],o=[],u=r.target,i(r.options).then(function(r){var i;return i=t(r.form),e.each(r.fieldNames,function(e){var t;return s[e]=i.find("[name='"+e+"']"),t=function(e){return function(){var t;return t={event:event,name:e,value:s[e].val()},t}}(e),o.change=s[e].asKefirStream(event,t).onValue(function(e){return console.debug("ON VALUE:::",e)})}),console.debug("streams",o),n.resolve()})},l=function(){return e.each(g,function(e){return e.remove()})},m={context:{destroy:function(e,t){return e.resolve(l)}},factories:{cloneStructure:c},facets:{addFilter:{ready:u},onFiltered:{ready:v},bindFiltersToFields:{ready:a}}},m}});
